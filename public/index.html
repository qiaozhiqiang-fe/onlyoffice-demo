<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>ONLYOFFICE PPT é¢„è§ˆ Demo</title>
    <script src="http://localhost:8080/web-apps/apps/api/documents/api.js"></script>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .upload-section {
        border-bottom: 1px solid #eee;
        padding-bottom: 20px;
        margin-bottom: 20px;
      }

      .file-upload {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
      }

      .upload-btn {
        padding: 10px 20px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s ease;
      }

      .upload-btn:hover {
        background: #5a6fd8;
      }

      .mode-selector {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
      }

      .mode-buttons {
        display: flex;
        border: 1px solid #ddd;
        border-radius: 6px;
        overflow: hidden;
      }

      .mode-btn {
        padding: 8px 16px;
        background: white;
        border: none;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
      }

      .mode-btn.active {
        background: #667eea;
        color: white;
      }

      .mode-btn:hover:not(.active) {
        background: #f8f9ff;
      }

      .control-buttons {
        display: none;
        gap: 10px;
        margin-top: 15px;
      }

      .control-buttons.show {
        display: flex;
      }

      .control-btn {
        padding: 8px 16px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s ease;
      }

      .control-btn:hover {
        background: #5a6fd8;
      }

      #viewer {
        width: 100%;
        height: 800px !important;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #fafafa;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        font-size: 16px;
      }

      #viewer.loaded {
        background: white;
        color: inherit;
      }

      /* ç¡®ä¿OnlyOffice iframeå¡«æ»¡å®¹å™¨ */
      #viewer iframe {
        width: 100% !important;
        height: 100% !important;
        border: none;
      }

      /* ç¡®ä¿OnlyOfficeå®¹å™¨å…ƒç´ çš„é«˜åº¦ */
      #viewer > div {
        height: 100% !important;
      }

      .status-info {
        margin-top: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 14px;
        color: #666;
        display: none;
      }

      .status-info.show {
        display: block;
      }

      .error-message {
        color: #dc3545;
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      .mode-description {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      .presentation-note {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        color: #0066cc;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 14px;
        display: none;
      }

      .presentation-note.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>ğŸ“Š ONLYOFFICE PPT é¢„è§ˆ Demo</h2>

      <div class="upload-section">
        <div class="file-upload">
          <input type="file" id="fileInput" accept=".ppt,.pptx" style="display: none;" />
          <button class="upload-btn" onclick="document.getElementById('fileInput').click()">é€‰æ‹©PPTæ–‡ä»¶</button>
        </div>

        <div class="mode-selector">
          <label>æŸ¥çœ‹æ¨¡å¼ï¼š</label>
          <div class="mode-buttons">
            <button class="mode-btn active" data-mode="view">ğŸ“„ é¢„è§ˆæ¨¡å¼</button>
            <button class="mode-btn" data-mode="presentation">ğŸ¥ æ¼”ç¤ºæ¨¡å¼</button>
          </div>
        </div>

        <div class="mode-description">
          <span id="modeDesc">é¢„è§ˆæ¨¡å¼ï¼šå¯æŸ¥çœ‹å’Œæµè§ˆPPTå†…å®¹</span>
        </div>

        <div class="presentation-note" id="presentationNote">
          ğŸ’¡ æ¼”ç¤ºæ¨¡å¼ï¼šé€‰æ‹©æ–‡ä»¶åå°†è‡ªåŠ¨è¿›å…¥å…¨å±å¹»ç¯ç‰‡æ’­æ”¾ï¼Œä½¿ç”¨æ–¹å‘é”®æˆ–é¼ æ ‡æ§åˆ¶åˆ‡æ¢ï¼ŒæŒ‰ESCé€€å‡º
        </div>

        <div class="control-buttons" id="controlButtons">
          <button class="control-btn" id="reloadBtn">ğŸ”„ é‡æ–°åŠ è½½</button>
          <button class="control-btn" id="startSlideshowBtn" style="display: none;">â–¶ï¸ å¼€å§‹å¹»ç¯ç‰‡</button>
          <button class="control-btn" id="endSlideshowBtn" style="display: none;">â¹ï¸ ç»“æŸå¹»ç¯ç‰‡</button>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="status-info" id="statusInfo">è¯·é€‰æ‹©ä¸€ä¸ªPPTæ–‡ä»¶å¼€å§‹é¢„è§ˆ</div>
      </div>

      <div id="viewer">è¯·å…ˆä¸Šä¼ PPTæ–‡ä»¶</div>
    </div>

    <script>
      let currentFile = null;
      let currentMode = 'view';
      let docEditor = null;

      const fileInput = document.getElementById('fileInput');
      const modeButtons = document.querySelectorAll('.mode-btn');
      const controlButtons = document.getElementById('controlButtons');
      const reloadBtn = document.getElementById('reloadBtn');
      const startSlideshowBtn = document.getElementById('startSlideshowBtn');
      const endSlideshowBtn = document.getElementById('endSlideshowBtn');
      const statusInfo = document.getElementById('statusInfo');
      const errorMessage = document.getElementById('errorMessage');
      const viewer = document.getElementById('viewer');
      const modeDesc = document.getElementById('modeDesc');
      const presentationNote = document.getElementById('presentationNote');

      const modeDescriptions = {
        view: 'é¢„è§ˆæ¨¡å¼ï¼šå¯æŸ¥çœ‹å’Œæµè§ˆPPTå†…å®¹',
        presentation: 'æ¼”ç¤ºæ¨¡å¼ï¼šé€‰æ‹©æ–‡ä»¶åè‡ªåŠ¨è¿›å…¥å¹»ç¯ç‰‡æ’­æ”¾'
      };

      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.add('show');
        setTimeout(() => {
          errorMessage.classList.remove('show');
        }, 5000);
      }

      // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
      function showStatus(message) {
        statusInfo.textContent = message;
        statusInfo.classList.add('show');
      }

      // éšè—çŠ¶æ€ä¿¡æ¯
      function hideStatus() {
        statusInfo.classList.remove('show');
      }

      // æ¨¡å¼åˆ‡æ¢
      modeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          modeButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentMode = btn.dataset.mode;

          // æ›´æ–°æ¨¡å¼æè¿°
          modeDesc.textContent = modeDescriptions[currentMode];

          // æ˜¾ç¤º/éšè—æ¼”ç¤ºæ¨¡å¼è¯´æ˜
          if (currentMode === 'presentation') {
            presentationNote.classList.add('show');
          } else {
            presentationNote.classList.remove('show');
          }

          // å¦‚æœå·²æœ‰æ–‡ä»¶ï¼Œé‡æ–°åŠ è½½
          if (currentFile) {
            loadDocument(currentFile, currentMode);
          }
        });
      });

      // åŠ è½½æ–‡æ¡£
      async function loadDocument(file, mode) {
        try {
          showStatus(`æ­£åœ¨åŠ è½½${mode === 'presentation' ? 'æ¼”ç¤º' : 'é¢„è§ˆ'}æ¨¡å¼...`);

          const formData = new FormData();
          formData.append("ppt", file);
          formData.append("mode", mode);

          const res = await fetch("http://localhost:3000/upload", {
            method: "POST",
            body: formData,
          });

          if (!res.ok) {
            throw new Error(`Upload failed: ${res.status}`);
          }

          const config = await res.json();

          // ç¡®ä¿é«˜åº¦è®¾ç½®æ­£ç¡®
          config.height = "800px";
          config.width = "100%";

          // æ¸…ç©ºviewerå†…å®¹
          viewer.innerHTML = "";
          viewer.classList.add('loaded');

          // æ·»åŠ æ–‡æ¡£å°±ç»ªäº‹ä»¶å¤„ç†
          config.events = {
            onDocumentReady: function() {
              hideStatus();
              controlButtons.classList.add('show');

              // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºç›¸åº”çš„æ§åˆ¶æŒ‰é’®
              if (mode === 'presentation') {
                startSlideshowBtn.style.display = 'inline-block';
                endSlideshowBtn.style.display = 'none';

                showStatus('ğŸ¥ æ¼”ç¤ºæ¨¡å¼å·²å¯åŠ¨ï¼Œæ­£åœ¨è¿›å…¥å¹»ç¯ç‰‡æ’­æ”¾...');

                // å»¶è¿Ÿç¡®ä¿æ–‡æ¡£å®Œå…¨åŠ è½½ï¼Œç„¶åå¯åŠ¨å¹»ç¯ç‰‡
                setTimeout(() => {
                  try {
                    // ä½¿ç”¨æ­£ç¡®çš„ OnlyOffice API æ–¹æ³• (OnlyOffice 8.0+)
                    if (window.Asc && window.Asc.plugin && window.Asc.plugin.executeMethod) {
                      window.Asc.plugin.executeMethod("StartSlideShow");
                      startSlideshowBtn.style.display = 'none';
                      endSlideshowBtn.style.display = 'inline-block';
                      showStatus('ğŸ¥ å¹»ç¯ç‰‡æ’­æ”¾å·²å¯åŠ¨ï¼Œä½¿ç”¨æ–¹å‘é”®åˆ‡æ¢ï¼ŒæŒ‰ESCé€€å‡º');

                      // è¯·æ±‚å…¨å±
                      setTimeout(() => {
                        if (viewer.requestFullscreen) {
                          viewer.requestFullscreen().catch(err => {
                            console.log('å…¨å±è¯·æ±‚å¤±è´¥:', err);
                          });
                        } else if (viewer.webkitRequestFullscreen) {
                          viewer.webkitRequestFullscreen();
                        } else if (viewer.msRequestFullscreen) {
                          viewer.msRequestFullscreen();
                        }
                      }, 500);
                    } else {
                      throw new Error('OnlyOffice API æœªå®Œå…¨åŠ è½½');
                    }
                  } catch (error) {
                    console.error('å¯åŠ¨å¹»ç¯ç‰‡å¤±è´¥:', error);
                    showError('è‡ªåŠ¨å¯åŠ¨å¹»ç¯ç‰‡å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»"å¼€å§‹å¹»ç¯ç‰‡"æŒ‰é’®æˆ–æ–‡æ¡£å·¥å…·æ ä¸­çš„æ’­æ”¾æŒ‰é’®ï¼ˆâ–¶ï¸å›¾æ ‡ï¼‰');
                  }
                }, 2000);
              } else {
                startSlideshowBtn.style.display = 'none';
                endSlideshowBtn.style.display = 'none';
                showStatus('ğŸ“„ é¢„è§ˆæ¨¡å¼å·²åŠ è½½');
              }
            },
            onError: function(event) {
              showError('æ–‡æ¡£åŠ è½½å¤±è´¥: ' + (event.data || 'æœªçŸ¥é”™è¯¯'));
            },
            onSlideShowStart: function() {
              console.log('å¹»ç¯ç‰‡æ’­æ”¾å·²å¼€å§‹');
              startSlideshowBtn.style.display = 'none';
              endSlideshowBtn.style.display = 'inline-block';
              showStatus('ğŸ¥ å¹»ç¯ç‰‡æ’­æ”¾å·²å¼€å§‹ï¼Œä½¿ç”¨æ–¹å‘é”®åˆ‡æ¢ï¼ŒæŒ‰ESCé€€å‡º');
            },
            onSlideShowEnd: function() {
              console.log('å¹»ç¯ç‰‡æ’­æ”¾å·²ç»“æŸ');
              startSlideshowBtn.style.display = 'inline-block';
              endSlideshowBtn.style.display = 'none';
              showStatus('å¹»ç¯ç‰‡æ’­æ”¾å·²ç»“æŸ');
              // é€€å‡ºå…¨å±
              if (document.exitFullscreen) {
                document.exitFullscreen();
              } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
              } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
              }
            }
          };

          // åˆå§‹åŒ–ç¼–è¾‘å™¨
          docEditor = new DocsAPI.DocEditor("viewer", config);
          currentFile = file;

        } catch (error) {
          console.error("Error loading document:", error);
          showError("æ–‡æ¡£åŠ è½½å¤±è´¥: " + error.message);
          hideStatus();
        }
      }

      // æ–‡ä»¶é€‰æ‹©å¤„ç†
      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          loadDocument(file, currentMode);
        }
      });

      // é‡æ–°åŠ è½½æŒ‰é’®
      reloadBtn.addEventListener('click', () => {
        if (currentFile) {
          loadDocument(currentFile, currentMode);
        }
      });

      // æ‰‹åŠ¨å¼€å§‹å¹»ç¯ç‰‡æŒ‰é’®
      startSlideshowBtn.addEventListener('click', () => {
        try {
          if (window.Asc && window.Asc.plugin && window.Asc.plugin.executeMethod) {
            window.Asc.plugin.executeMethod("StartSlideShow");
            showStatus('ğŸ¥ æ‰‹åŠ¨å¯åŠ¨å¹»ç¯ç‰‡æ’­æ”¾');

            // è¯·æ±‚å…¨å±
            setTimeout(() => {
              if (viewer.requestFullscreen) {
                viewer.requestFullscreen();
              } else if (viewer.webkitRequestFullscreen) {
                viewer.webkitRequestFullscreen();
              } else if (viewer.msRequestFullscreen) {
                viewer.msRequestFullscreen();
              }
            }, 500);
          } else {
            showError('OnlyOffice API æœªåŠ è½½ï¼Œæ— æ³•å¯åŠ¨å¹»ç¯ç‰‡');
          }
        } catch (error) {
          console.error('æ‰‹åŠ¨å¯åŠ¨å¹»ç¯ç‰‡å¤±è´¥:', error);
          showError('å¯åŠ¨å¹»ç¯ç‰‡å¤±è´¥: ' + error.message);
        }
      });

      // æ‰‹åŠ¨ç»“æŸå¹»ç¯ç‰‡æŒ‰é’®
      endSlideshowBtn.addEventListener('click', () => {
        try {
          if (window.Asc && window.Asc.plugin && window.Asc.plugin.executeMethod) {
            window.Asc.plugin.executeMethod("EndSlideShow");
            showStatus('å·²ç»“æŸå¹»ç¯ç‰‡æ’­æ”¾');
          } else {
            showError('OnlyOffice API æœªåŠ è½½ï¼Œæ— æ³•ç»“æŸå¹»ç¯ç‰‡');
          }
        } catch (error) {
          console.error('ç»“æŸå¹»ç¯ç‰‡å¤±è´¥:', error);
          showError('ç»“æŸå¹»ç¯ç‰‡å¤±è´¥: ' + error.message);
        }
      });

      // é”®ç›˜å¿«æ·é”®æ”¯æŒ
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          // ESCé”®é€€å‡ºå…¨å±
          if (document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement) {
            if (document.exitFullscreen) {
              document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
              document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
              document.msExitFullscreen();
            }
          }
        } else if (e.key === 'F5' && currentFile) {
          e.preventDefault();
          // F5å¿«é€Ÿå¯åŠ¨æ¼”ç¤ºæ¨¡å¼
          if (currentMode !== 'presentation') {
            modeButtons[1].click(); // åˆ‡æ¢åˆ°æ¼”ç¤ºæ¨¡å¼
          } else {
            loadDocument(currentFile, 'presentation'); // é‡æ–°åŠ è½½æ¼”ç¤ºæ¨¡å¼
          }
        }
      });

      // ç›‘å¬å…¨å±å˜åŒ–äº‹ä»¶
      document.addEventListener('fullscreenchange', () => {
        if (!document.fullscreenElement) {
          showStatus('å·²é€€å‡ºå…¨å±æ¨¡å¼');
        }
      });

      document.addEventListener('webkitfullscreenchange', () => {
        if (!document.webkitFullscreenElement) {
          showStatus('å·²é€€å‡ºå…¨å±æ¨¡å¼');
        }
      });
    </script>
  </body>
</html>
